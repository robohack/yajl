<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<!-- This HTML file generated by cxref (version 1.6d). -->
<!-- cxref program (c) Andrew M. Bishop 1995-2011. -->

<!--
Cxref: cxref -warn-all -xref-all -block-comments -O/work/woods/f-yajl/build/work/woods/f-yajl/doc/html -Nyajl -html -html-src -I/work/woods/f-yajl/src -I/work/woods/f-yajl/build/work/woods/f-yajl/./src-CPP "cc -E -CC -x c" src/yajl_parser.c
CPP  : cc -E -CC -x c -Isrc -Ibuild/work/woods/f-yajl/./src
-->

<HTML>

<HEAD>
<TITLE>Source File src/yajl_parser.c</TITLE>
<LINK rel="stylesheet" href="../cxref.css" type="text/css">
</HEAD>

<BODY>

<pre>
<a name="line1">1    |</a> /*
<a name="line2">2    |</a>  * Copyright (c) 2007-2014, Lloyd Hilaiel &lt;me@lloyd.io&gt;
<a name="line3">3    |</a>  *
<a name="line4">4    |</a>  * Permission to use, copy, modify, and/or distribute this software for any
<a name="line5">5    |</a>  * purpose with or without fee is hereby granted, provided that the above
<a name="line6">6    |</a>  * copyright notice and this permission notice appear in all copies.
<a name="line7">7    |</a>  *
<a name="line8">8    |</a>  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
<a name="line9">9    |</a>  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
<a name="line10">10   |</a>  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
<a name="line11">11   |</a>  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
<a name="line12">12   |</a>  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
<a name="line13">13   |</a>  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
<a name="line14">14   |</a>  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
<a name="line15">15   |</a>  */
<a name="line16">16   |</a> 
<a name="line17">17   |</a> #include "yajl/yajl_parse.h"
<a name="line18">18   |</a> #include "yajl_lex.h"
<a name="line19">19   |</a> #include "yajl_parser.h"
<a name="line20">20   |</a> #include "yajl_encode.h"
<a name="line21">21   |</a> #include "yajl_bytestack.h"
<a name="line22">22   |</a> 
<a name="line23">23   |</a> #include &lt;stdlib.h&gt;
<a name="line24">24   |</a> #include &lt;limits.h&gt;
<a name="line25">25   |</a> #include &lt;errno.h&gt;
<a name="line26">26   |</a> #include &lt;stdio.h&gt;
<a name="line27">27   |</a> #include &lt;string.h&gt;
<a name="line28">28   |</a> #include &lt;ctype.h&gt;
<a name="line29">29   |</a> #include &lt;assert.h&gt;
<a name="line30">30   |</a> #include &lt;math.h&gt;
<a name="line31">31   |</a> 
<a name="line32">32   |</a> #define MAX_VALUE_TO_MULTIPLY ((LLONG_MAX / 10) + (LLONG_MAX % 10))
<a name="line33">33   |</a> 
<a name="line34">34   |</a>  /* same semantics as strtol */
<a name="line35">35   |</a> long long
<a name="line36">36   |</a> yajl_parse_integer(const unsigned char *number, size_t length)
<a name="line37">37   |</a> {
<a name="line38">38   |</a>     long long ret  = 0;
<a name="line39">39   |</a>     long sign = 1;
<a name="line40">40   |</a>     const unsigned char *pos = number;
<a name="line41">41   |</a>     if (*pos == '-') { pos++; sign = -1; }
<a name="line42">42   |</a>     if (*pos == '+') { pos++; }
<a name="line43">43   |</a> 
<a name="line44">44   |</a>     while (pos &lt; number + length) {
<a name="line45">45   |</a>         if ( ret &gt; MAX_VALUE_TO_MULTIPLY ) {
<a name="line46">46   |</a>             errno = ERANGE;
<a name="line47">47   |</a>             return sign == 1 ? LLONG_MAX : LLONG_MIN;
<a name="line48">48   |</a>         }
<a name="line49">49   |</a>         ret *= 10;
<a name="line50">50   |</a>         if (LLONG_MAX - ret &lt; (*pos - '0')) {
<a name="line51">51   |</a>             errno = ERANGE;
<a name="line52">52   |</a>             return sign == 1 ? LLONG_MAX : LLONG_MIN;
<a name="line53">53   |</a>         }
<a name="line54">54   |</a>         if (*pos &lt; '0' || *pos &gt; '9') {
<a name="line55">55   |</a>             errno = ERANGE;
<a name="line56">56   |</a>             return sign == 1 ? LLONG_MAX : LLONG_MIN;
<a name="line57">57   |</a>         }
<a name="line58">58   |</a>         ret += (*pos++ - '0');
<a name="line59">59   |</a>     }
<a name="line60">60   |</a> 
<a name="line61">61   |</a>     return sign * ret;
<a name="line62">62   |</a> }
<a name="line63">63   |</a> 
<a name="line64">64   |</a> unsigned char *
<a name="line65">65   |</a> yajl_render_error_string(yajl_handle hand, const unsigned char * jsonText,
<a name="line66">66   |</a>                          size_t jsonTextLen, int verbose)
<a name="line67">67   |</a> {
<a name="line68">68   |</a>     size_t offset = hand-&gt;bytesConsumed;
<a name="line69">69   |</a>     unsigned char * str;
<a name="line70">70   |</a>     const char * errorType = NULL;
<a name="line71">71   |</a>     const char * errorText = NULL;
<a name="line72">72   |</a>     unsigned char text[72];
<a name="line73">73   |</a>     const char * arrow = "                    (right here) ------^\n";
<a name="line74">74   |</a> 
<a name="line75">75   |</a>     if (yajl_bs_current(hand-&gt;stateStack) == yajl_state_parse_error) {
<a name="line76">76   |</a>         errorType = "parse";
<a name="line77">77   |</a>         errorText = hand-&gt;parseError;
<a name="line78">78   |</a>     } else if (yajl_bs_current(hand-&gt;stateStack) == yajl_state_lexical_error) {
<a name="line79">79   |</a>         errorType = "lexical";
<a name="line80">80   |</a>         errorText = yajl_lex_error_to_string(yajl_lex_get_error(hand-&gt;lexer));
<a name="line81">81   |</a>     } else {
<a name="line82">82   |</a>         errorType = "unknown";
<a name="line83">83   |</a>     }
<a name="line84">84   |</a> 
<a name="line85">85   |</a>     {
<a name="line86">86   |</a>         size_t memneeded = 0;
<a name="line87">87   |</a>         memneeded += strlen(errorType);
<a name="line88">88   |</a>         memneeded += strlen(" error");
<a name="line89">89   |</a>         if (errorText != NULL) {
<a name="line90">90   |</a>             memneeded += strlen(": ");
<a name="line91">91   |</a>             memneeded += strlen(errorText);
<a name="line92">92   |</a>         }
<a name="line93">93   |</a>         str = (unsigned char *) YA_MALLOC(&amp;(hand-&gt;alloc), memneeded + 2);
<a name="line94">94   |</a>         if (!str) return NULL;
<a name="line95">95   |</a>         str[0] = 0;
<a name="line96">96   |</a>         strcat((char *) str, errorType);
<a name="line97">97   |</a>         strcat((char *) str, " error");
<a name="line98">98   |</a>         if (errorText != NULL) {
<a name="line99">99   |</a>             strcat((char *) str, ": ");
<a name="line100">100  |</a>             strcat((char *) str, errorText);
<a name="line101">101  |</a>         }
<a name="line102">102  |</a>         strcat((char *) str, "\n");
<a name="line103">103  |</a>     }
<a name="line104">104  |</a> 
<a name="line105">105  |</a>     /* now, if verbose was specified, we append as many spaces as needed to make
<a name="line106">106  |</a>      * sure the error falls at char 40 */
<a name="line107">107  |</a>     if (verbose) {
<a name="line108">108  |</a>         size_t start, end, i;
<a name="line109">109  |</a>         size_t spacesNeeded;
<a name="line110">110  |</a> 
<a name="line111">111  |</a>         /* xxx this doesn't seem to be working right.... */
<a name="line112">112  |</a>         spacesNeeded = (offset &lt; 30 ? 40 - offset : 10);
<a name="line113">113  |</a>         start = (offset &gt;= 30 ? offset - 30 : 0);
<a name="line114">114  |</a>         end = (offset + 30 &gt; jsonTextLen ? jsonTextLen : offset + 30);
<a name="line115">115  |</a> 
<a name="line116">116  |</a>         for (i=0; i &lt; spacesNeeded; i++) {
<a name="line117">117  |</a>             text[i] = ' ';
<a name="line118">118  |</a>         }
<a name="line119">119  |</a> 
<a name="line120">120  |</a>         for (; start &lt; end; start++, i++) {
<a name="line121">121  |</a>             if (jsonText[start] != '\n' &amp;&amp; jsonText[start] != '\r') {
<a name="line122">122  |</a>                 text[i] = jsonText[start];
<a name="line123">123  |</a>             } else {
<a name="line124">124  |</a>                 text[i] = ' ';
<a name="line125">125  |</a>             }
<a name="line126">126  |</a>         }
<a name="line127">127  |</a>         assert(i &lt;= 71);
<a name="line128">128  |</a>         text[i++] = '\n';
<a name="line129">129  |</a>         text[i] = 0;
<a name="line130">130  |</a>         {
<a name="line131">131  |</a>             char * newStr = (char *)
<a name="line132">132  |</a>                 YA_MALLOC(&amp;(hand-&gt;alloc), (size_t)(strlen((char *) str) +
<a name="line133">133  |</a>                                                    strlen((char *) text) +
<a name="line134">134  |</a>                                                    strlen(arrow) + 1));
<a name="line135">135  |</a>             if (newStr) {
<a name="line136">136  |</a>                 newStr[0] = 0;
<a name="line137">137  |</a>                 strcat((char *) newStr, (char *) str);
<a name="line138">138  |</a>                 strcat((char *) newStr, (char *) text);
<a name="line139">139  |</a>                 strcat((char *) newStr, arrow);
<a name="line140">140  |</a>             }
<a name="line141">141  |</a>             YA_FREE(&amp;(hand-&gt;alloc), str);
<a name="line142">142  |</a>             str = (unsigned char *) newStr;
<a name="line143">143  |</a>         }
<a name="line144">144  |</a>     }
<a name="line145">145  |</a>     return str;
<a name="line146">146  |</a> }
<a name="line147">147  |</a> 
<a name="line148">148  |</a> /* check for client cancelation */
<a name="line149">149  |</a> #define _CC_CHK(x)                                                \
<a name="line150">150  |</a>     if (!(x)) {                                                   \
<a name="line151">151  |</a>         yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);    \
<a name="line152">152  |</a>         hand-&gt;parseError =                                        \
<a name="line153">153  |</a>             "client cancelled parse via callback return value";   \
<a name="line154">154  |</a>         return yajl_status_client_canceled;                       \
<a name="line155">155  |</a>     }
<a name="line156">156  |</a> 
<a name="line157">157  |</a> 
<a name="line158">158  |</a> yajl_status
<a name="line159">159  |</a> yajl_do_finish(yajl_handle hand)
<a name="line160">160  |</a> {
<a name="line161">161  |</a>     yajl_status stat;
<a name="line162">162  |</a>     stat = yajl_do_parse(hand,(const unsigned char *) " ",(size_t) 1);
<a name="line163">163  |</a> 
<a name="line164">164  |</a>     if (stat != yajl_status_ok) return stat;
<a name="line165">165  |</a> 
<a name="line166">166  |</a>     switch(yajl_bs_current(hand-&gt;stateStack))
<a name="line167">167  |</a>     {
<a name="line168">168  |</a>         case yajl_state_parse_error:
<a name="line169">169  |</a>         case yajl_state_lexical_error:
<a name="line170">170  |</a>             return yajl_status_error;
<a name="line171">171  |</a>         case yajl_state_got_value:
<a name="line172">172  |</a>         case yajl_state_parse_complete:
<a name="line173">173  |</a>             return yajl_status_ok;
<a name="line174">174  |</a>         default:
<a name="line175">175  |</a>             if (!(hand-&gt;flags &amp; yajl_allow_partial_values))
<a name="line176">176  |</a>             {
<a name="line177">177  |</a>                 yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);
<a name="line178">178  |</a>                 hand-&gt;parseError = "premature EOF";
<a name="line179">179  |</a>                 return yajl_status_error;
<a name="line180">180  |</a>             }
<a name="line181">181  |</a>             return yajl_status_ok;
<a name="line182">182  |</a>     }
<a name="line183">183  |</a> }
<a name="line184">184  |</a> 
<a name="line185">185  |</a> yajl_status
<a name="line186">186  |</a> yajl_do_parse(yajl_handle hand, const unsigned char * jsonText,
<a name="line187">187  |</a>               size_t jsonTextLen)
<a name="line188">188  |</a> {
<a name="line189">189  |</a>     yajl_tok tok;
<a name="line190">190  |</a>     const unsigned char * buf;
<a name="line191">191  |</a>     size_t bufLen;
<a name="line192">192  |</a>     size_t * offset = &amp;(hand-&gt;bytesConsumed);
<a name="line193">193  |</a> 
<a name="line194">194  |</a>     *offset = 0;
<a name="line195">195  |</a> 
<a name="line196">196  |</a>   around_again:
<a name="line197">197  |</a>     switch (yajl_bs_current(hand-&gt;stateStack)) {
<a name="line198">198  |</a>         case yajl_state_parse_complete:
<a name="line199">199  |</a>             if (hand-&gt;flags &amp; yajl_allow_multiple_values) {
<a name="line200">200  |</a>                 yajl_bs_set(hand-&gt;stateStack, yajl_state_got_value);
<a name="line201">201  |</a>                 goto around_again;
<a name="line202">202  |</a>             }
<a name="line203">203  |</a>             if (!(hand-&gt;flags &amp; yajl_allow_trailing_garbage)) {
<a name="line204">204  |</a>                 if (*offset != jsonTextLen) {
<a name="line205">205  |</a>                     tok = yajl_lex_lex(hand-&gt;lexer, jsonText, jsonTextLen,
<a name="line206">206  |</a>                                        offset, &amp;buf, &amp;bufLen);
<a name="line207">207  |</a>                     if (tok != yajl_tok_eof) {
<a name="line208">208  |</a>                         yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);
<a name="line209">209  |</a>                         hand-&gt;parseError = "trailing garbage";
<a name="line210">210  |</a>                     }
<a name="line211">211  |</a>                     goto around_again;
<a name="line212">212  |</a>                 }
<a name="line213">213  |</a>             }
<a name="line214">214  |</a>             return yajl_status_ok;
<a name="line215">215  |</a>         case yajl_state_lexical_error:
<a name="line216">216  |</a>         case yajl_state_parse_error:
<a name="line217">217  |</a>             return yajl_status_error;
<a name="line218">218  |</a>         case yajl_state_start:
<a name="line219">219  |</a>         case yajl_state_got_value:
<a name="line220">220  |</a>         case yajl_state_map_need_val:
<a name="line221">221  |</a>         case yajl_state_array_need_val:
<a name="line222">222  |</a>         case yajl_state_array_start:  {
<a name="line223">223  |</a>             /* for arrays and maps, we advance the state for this
<a name="line224">224  |</a>              * depth, then push the state of the next depth.
<a name="line225">225  |</a>              * If an error occurs during the parsing of the nesting
<a name="line226">226  |</a>              * enitity, the state at this level will not matter.
<a name="line227">227  |</a>              * a state that needs pushing will be anything other
<a name="line228">228  |</a>              * than state_start */
<a name="line229">229  |</a> 
<a name="line230">230  |</a>             yajl_state stateToPush = yajl_state_start;
<a name="line231">231  |</a> 
<a name="line232">232  |</a>             tok = yajl_lex_lex(hand-&gt;lexer, jsonText, jsonTextLen,
<a name="line233">233  |</a>                                offset, &amp;buf, &amp;bufLen);
<a name="line234">234  |</a> 
<a name="line235">235  |</a>             switch (tok) {
<a name="line236">236  |</a>                 case yajl_tok_eof:
<a name="line237">237  |</a>                     return yajl_status_ok;
<a name="line238">238  |</a>                 case yajl_tok_error:
<a name="line239">239  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_lexical_error);
<a name="line240">240  |</a>                     goto around_again;
<a name="line241">241  |</a>                 case yajl_tok_string:
<a name="line242">242  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_string) {
<a name="line243">243  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_string(hand-&gt;ctx,
<a name="line244">244  |</a>                                                              buf, bufLen));
<a name="line245">245  |</a>                     }
<a name="line246">246  |</a>                     break;
<a name="line247">247  |</a>                 case yajl_tok_string_with_escapes:
<a name="line248">248  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_string) {
<a name="line249">249  |</a>                         yajl_buf_clear(hand-&gt;decodeBuf);
<a name="line250">250  |</a>                         yajl_string_decode(hand-&gt;decodeBuf, buf, bufLen);
<a name="line251">251  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_string(
<a name="line252">252  |</a>                                     hand-&gt;ctx, yajl_buf_data(hand-&gt;decodeBuf),
<a name="line253">253  |</a>                                     yajl_buf_len(hand-&gt;decodeBuf)));
<a name="line254">254  |</a>                     }
<a name="line255">255  |</a>                     break;
<a name="line256">256  |</a>                 case yajl_tok_bool:
<a name="line257">257  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_boolean) {
<a name="line258">258  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_boolean(hand-&gt;ctx,
<a name="line259">259  |</a>                                                               *buf == 't'));
<a name="line260">260  |</a>                     }
<a name="line261">261  |</a>                     break;
<a name="line262">262  |</a>                 case yajl_tok_null:
<a name="line263">263  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_null) {
<a name="line264">264  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_null(hand-&gt;ctx));
<a name="line265">265  |</a>                     }
<a name="line266">266  |</a>                     break;
<a name="line267">267  |</a>                 case yajl_tok_left_bracket:
<a name="line268">268  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_start_map) {
<a name="line269">269  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_start_map(hand-&gt;ctx));
<a name="line270">270  |</a>                     }
<a name="line271">271  |</a>                     stateToPush = yajl_state_map_start;
<a name="line272">272  |</a>                     break;
<a name="line273">273  |</a>                 case yajl_tok_left_brace:
<a name="line274">274  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_start_array) {
<a name="line275">275  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_start_array(hand-&gt;ctx));
<a name="line276">276  |</a>                     }
<a name="line277">277  |</a>                     stateToPush = yajl_state_array_start;
<a name="line278">278  |</a>                     break;
<a name="line279">279  |</a>                 case yajl_tok_integer:
<a name="line280">280  |</a>                     if (hand-&gt;callbacks) {
<a name="line281">281  |</a>                         if (hand-&gt;callbacks-&gt;yajl_number) {
<a name="line282">282  |</a>                             _CC_CHK(hand-&gt;callbacks-&gt;yajl_number(
<a name="line283">283  |</a>                                         hand-&gt;ctx,(const char *) buf, bufLen));
<a name="line284">284  |</a>                         } else if (hand-&gt;callbacks-&gt;yajl_integer) {
<a name="line285">285  |</a>                             long long int i = 0;
<a name="line286">286  |</a>                             errno = 0;
<a name="line287">287  |</a>                             i = yajl_parse_integer(buf, bufLen);
<a name="line288">288  |</a>                             if ((i == LLONG_MIN || i == LLONG_MAX) &amp;&amp;
<a name="line289">289  |</a>                                 errno == ERANGE)
<a name="line290">290  |</a>                             {
<a name="line291">291  |</a>                                 yajl_bs_set(hand-&gt;stateStack,
<a name="line292">292  |</a>                                             yajl_state_parse_error);
<a name="line293">293  |</a>                                 hand-&gt;parseError = "integer overflow" ;
<a name="line294">294  |</a>                                 /* try to restore error offset */
<a name="line295">295  |</a>                                 if (*offset &gt;= bufLen) *offset -= bufLen;
<a name="line296">296  |</a>                                 else *offset = 0;
<a name="line297">297  |</a>                                 goto around_again;
<a name="line298">298  |</a>                             }
<a name="line299">299  |</a>                             _CC_CHK(hand-&gt;callbacks-&gt;yajl_integer(hand-&gt;ctx,
<a name="line300">300  |</a>                                                                   i));
<a name="line301">301  |</a>                         }
<a name="line302">302  |</a>                     }
<a name="line303">303  |</a>                     break;
<a name="line304">304  |</a>                 case yajl_tok_double:
<a name="line305">305  |</a>                     if (hand-&gt;callbacks) {
<a name="line306">306  |</a>                         if (hand-&gt;callbacks-&gt;yajl_number) {
<a name="line307">307  |</a>                             _CC_CHK(hand-&gt;callbacks-&gt;yajl_number(
<a name="line308">308  |</a>                                         hand-&gt;ctx, (const char *) buf, bufLen));
<a name="line309">309  |</a>                         } else if (hand-&gt;callbacks-&gt;yajl_double) {
<a name="line310">310  |</a>                             double d = 0.0;
<a name="line311">311  |</a>                             yajl_buf_clear(hand-&gt;decodeBuf);
<a name="line312">312  |</a>                             yajl_buf_append(hand-&gt;decodeBuf, buf, bufLen);
<a name="line313">313  |</a>                             buf = yajl_buf_data(hand-&gt;decodeBuf);
<a name="line314">314  |</a>                             errno = 0;
<a name="line315">315  |</a>                             d = strtod((const char *) buf, NULL);
<a name="line316">316  |</a>                             if ((d == HUGE_VAL || d == -HUGE_VAL) &amp;&amp;
<a name="line317">317  |</a>                                 errno == ERANGE)
<a name="line318">318  |</a>                             {
<a name="line319">319  |</a>                                 yajl_bs_set(hand-&gt;stateStack,
<a name="line320">320  |</a>                                             yajl_state_parse_error);
<a name="line321">321  |</a>                                 hand-&gt;parseError = "numeric (floating point) "
<a name="line322">322  |</a>                                     "overflow";
<a name="line323">323  |</a>                                 /* try to restore error offset */
<a name="line324">324  |</a>                                 if (*offset &gt;= bufLen) *offset -= bufLen;
<a name="line325">325  |</a>                                 else *offset = 0;
<a name="line326">326  |</a>                                 goto around_again;
<a name="line327">327  |</a>                             }
<a name="line328">328  |</a>                             _CC_CHK(hand-&gt;callbacks-&gt;yajl_double(hand-&gt;ctx,
<a name="line329">329  |</a>                                                                  d));
<a name="line330">330  |</a>                         }
<a name="line331">331  |</a>                     }
<a name="line332">332  |</a>                     break;
<a name="line333">333  |</a>                 case yajl_tok_right_brace:
<a name="line334">334  |</a>                     if (yajl_bs_current(hand-&gt;stateStack) ==
<a name="line335">335  |</a>                         yajl_state_array_start)
<a name="line336">336  |</a>                     {
<a name="line337">337  |</a>                         if (hand-&gt;callbacks &amp;&amp;
<a name="line338">338  |</a>                             hand-&gt;callbacks-&gt;yajl_end_array)
<a name="line339">339  |</a>                         {
<a name="line340">340  |</a>                             _CC_CHK(hand-&gt;callbacks-&gt;yajl_end_array(hand-&gt;ctx));
<a name="line341">341  |</a>                         }
<a name="line342">342  |</a>                         yajl_bs_pop(hand-&gt;stateStack);
<a name="line343">343  |</a>                         goto around_again;
<a name="line344">344  |</a>                     }
<a name="line345">345  |</a>                     /* FALLTHROUGH */
<a name="line346">346  |</a>                 case yajl_tok_colon:
<a name="line347">347  |</a>                 case yajl_tok_comma:
<a name="line348">348  |</a>                 case yajl_tok_right_bracket:
<a name="line349">349  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);
<a name="line350">350  |</a>                     hand-&gt;parseError =
<a name="line351">351  |</a>                         "unallowed token at this point in JSON text";
<a name="line352">352  |</a>                     goto around_again;
<a name="line353">353  |</a>                 default:
<a name="line354">354  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);
<a name="line355">355  |</a>                     hand-&gt;parseError = "invalid token, internal error";
<a name="line356">356  |</a>                     goto around_again;
<a name="line357">357  |</a>             }
<a name="line358">358  |</a>             /* got a value.  transition depends on the state we're in. */
<a name="line359">359  |</a>             {
<a name="line360">360  |</a>                 yajl_state s = (yajl_state) yajl_bs_current(hand-&gt;stateStack);
<a name="line361">361  |</a>                 if (s == yajl_state_start || s == yajl_state_got_value) {
<a name="line362">362  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_complete);
<a name="line363">363  |</a>                 } else if (s == yajl_state_map_need_val) {
<a name="line364">364  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_map_got_val);
<a name="line365">365  |</a>                 } else {
<a name="line366">366  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_array_got_val);
<a name="line367">367  |</a>                 }
<a name="line368">368  |</a>             }
<a name="line369">369  |</a>             if (stateToPush != yajl_state_start) {
<a name="line370">370  |</a>                 yajl_bs_push(hand-&gt;stateStack, stateToPush);
<a name="line371">371  |</a>             }
<a name="line372">372  |</a> 
<a name="line373">373  |</a>             goto around_again;
<a name="line374">374  |</a>         }
<a name="line375">375  |</a>         case yajl_state_map_start:
<a name="line376">376  |</a>         case yajl_state_map_need_key: {
<a name="line377">377  |</a>             /* only difference between these two states is that in
<a name="line378">378  |</a>              * start '}' is valid, whereas in need_key, we've parsed
<a name="line379">379  |</a>              * a comma, and a string key _must_ follow */
<a name="line380">380  |</a>             tok = yajl_lex_lex(hand-&gt;lexer, jsonText, jsonTextLen,
<a name="line381">381  |</a>                                offset, &amp;buf, &amp;bufLen);
<a name="line382">382  |</a>             switch (tok) {
<a name="line383">383  |</a>                 case yajl_tok_eof:
<a name="line384">384  |</a>                     return yajl_status_ok;
<a name="line385">385  |</a>                 case yajl_tok_error:
<a name="line386">386  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_lexical_error);
<a name="line387">387  |</a>                     goto around_again;
<a name="line388">388  |</a>                 case yajl_tok_string_with_escapes:
<a name="line389">389  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_map_key) {
<a name="line390">390  |</a>                         yajl_buf_clear(hand-&gt;decodeBuf);
<a name="line391">391  |</a>                         yajl_string_decode(hand-&gt;decodeBuf, buf, bufLen);
<a name="line392">392  |</a>                         buf = yajl_buf_data(hand-&gt;decodeBuf);
<a name="line393">393  |</a>                         bufLen = yajl_buf_len(hand-&gt;decodeBuf);
<a name="line394">394  |</a>                     }
<a name="line395">395  |</a>                     /* FALLTHROUGH */
<a name="line396">396  |</a>                 case yajl_tok_string:
<a name="line397">397  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_map_key) {
<a name="line398">398  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_map_key(hand-&gt;ctx, buf,
<a name="line399">399  |</a>                                                               bufLen));
<a name="line400">400  |</a>                     }
<a name="line401">401  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_map_sep);
<a name="line402">402  |</a>                     goto around_again;
<a name="line403">403  |</a>                 case yajl_tok_right_bracket:
<a name="line404">404  |</a>                     if (yajl_bs_current(hand-&gt;stateStack) ==
<a name="line405">405  |</a>                         yajl_state_map_start)
<a name="line406">406  |</a>                     {
<a name="line407">407  |</a>                         if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_end_map) {
<a name="line408">408  |</a>                             _CC_CHK(hand-&gt;callbacks-&gt;yajl_end_map(hand-&gt;ctx));
<a name="line409">409  |</a>                         }
<a name="line410">410  |</a>                         yajl_bs_pop(hand-&gt;stateStack);
<a name="line411">411  |</a>                         goto around_again;
<a name="line412">412  |</a>                     }
<a name="line413">413  |</a>                     /* FALLTHROUGH */
<a name="line414">414  |</a>                 default:
<a name="line415">415  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);
<a name="line416">416  |</a>                     hand-&gt;parseError =
<a name="line417">417  |</a>                         "invalid object key (must be a string)"; 
<a name="line418">418  |</a>                     goto around_again;
<a name="line419">419  |</a>             }
<a name="line420">420  |</a>         }
<a name="line421">421  |</a>         case yajl_state_map_sep: {
<a name="line422">422  |</a>             tok = yajl_lex_lex(hand-&gt;lexer, jsonText, jsonTextLen,
<a name="line423">423  |</a>                                offset, &amp;buf, &amp;bufLen);
<a name="line424">424  |</a>             switch (tok) {
<a name="line425">425  |</a>                 case yajl_tok_colon:
<a name="line426">426  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_map_need_val);
<a name="line427">427  |</a>                     goto around_again;
<a name="line428">428  |</a>                 case yajl_tok_eof:
<a name="line429">429  |</a>                     return yajl_status_ok;
<a name="line430">430  |</a>                 case yajl_tok_error:
<a name="line431">431  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_lexical_error);
<a name="line432">432  |</a>                     goto around_again;
<a name="line433">433  |</a>                 default:
<a name="line434">434  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);
<a name="line435">435  |</a>                     hand-&gt;parseError = "object key and value must "
<a name="line436">436  |</a>                         "be separated by a colon (':')";
<a name="line437">437  |</a>                     goto around_again;
<a name="line438">438  |</a>             }
<a name="line439">439  |</a>         }
<a name="line440">440  |</a>         case yajl_state_map_got_val: {
<a name="line441">441  |</a>             tok = yajl_lex_lex(hand-&gt;lexer, jsonText, jsonTextLen,
<a name="line442">442  |</a>                                offset, &amp;buf, &amp;bufLen);
<a name="line443">443  |</a>             switch (tok) {
<a name="line444">444  |</a>                 case yajl_tok_right_bracket:
<a name="line445">445  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_end_map) {
<a name="line446">446  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_end_map(hand-&gt;ctx));
<a name="line447">447  |</a>                     }
<a name="line448">448  |</a>                     yajl_bs_pop(hand-&gt;stateStack);
<a name="line449">449  |</a>                     goto around_again;
<a name="line450">450  |</a>                 case yajl_tok_comma:
<a name="line451">451  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_map_need_key);
<a name="line452">452  |</a>                     goto around_again;
<a name="line453">453  |</a>                 case yajl_tok_eof:
<a name="line454">454  |</a>                     return yajl_status_ok;
<a name="line455">455  |</a>                 case yajl_tok_error:
<a name="line456">456  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_lexical_error);
<a name="line457">457  |</a>                     goto around_again;
<a name="line458">458  |</a>                 default:
<a name="line459">459  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);
<a name="line460">460  |</a>                     hand-&gt;parseError = "after key and value, inside map, "
<a name="line461">461  |</a>                                        "I expect ',' or '}'";
<a name="line462">462  |</a>                     /* try to restore error offset */
<a name="line463">463  |</a>                     if (*offset &gt;= bufLen) *offset -= bufLen;
<a name="line464">464  |</a>                     else *offset = 0;
<a name="line465">465  |</a>                     goto around_again;
<a name="line466">466  |</a>             }
<a name="line467">467  |</a>         }
<a name="line468">468  |</a>         case yajl_state_array_got_val: {
<a name="line469">469  |</a>             tok = yajl_lex_lex(hand-&gt;lexer, jsonText, jsonTextLen,
<a name="line470">470  |</a>                                offset, &amp;buf, &amp;bufLen);
<a name="line471">471  |</a>             switch (tok) {
<a name="line472">472  |</a>                 case yajl_tok_right_brace:
<a name="line473">473  |</a>                     if (hand-&gt;callbacks &amp;&amp; hand-&gt;callbacks-&gt;yajl_end_array) {
<a name="line474">474  |</a>                         _CC_CHK(hand-&gt;callbacks-&gt;yajl_end_array(hand-&gt;ctx));
<a name="line475">475  |</a>                     }
<a name="line476">476  |</a>                     yajl_bs_pop(hand-&gt;stateStack);
<a name="line477">477  |</a>                     goto around_again;
<a name="line478">478  |</a>                 case yajl_tok_comma:
<a name="line479">479  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_array_need_val);
<a name="line480">480  |</a>                     goto around_again;
<a name="line481">481  |</a>                 case yajl_tok_eof:
<a name="line482">482  |</a>                     return yajl_status_ok;
<a name="line483">483  |</a>                 case yajl_tok_error:
<a name="line484">484  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_lexical_error);
<a name="line485">485  |</a>                     goto around_again;
<a name="line486">486  |</a>                 default:
<a name="line487">487  |</a>                     yajl_bs_set(hand-&gt;stateStack, yajl_state_parse_error);
<a name="line488">488  |</a>                     hand-&gt;parseError =
<a name="line489">489  |</a>                         "after array element, I expect ',' or ']'";
<a name="line490">490  |</a>                     goto around_again;
<a name="line491">491  |</a>             }
<a name="line492">492  |</a>         }
<a name="line493">493  |</a>     }
<a name="line494">494  |</a> 
<a name="line495">495  |</a>     abort();
<a name="line496">496  |</a>     /* NOTREACHED */
<a name="line497">497  |</a>     return yajl_status_error;
<a name="line498">498  |</a> }
<a name="line499">499  |</a> 
</pre>

</BODY>
</HTML>
