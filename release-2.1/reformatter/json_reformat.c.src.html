<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<!-- This HTML file generated by cxref (version 1.6d). -->
<!-- cxref program (c) Andrew M. Bishop 1995-2011. -->

<!--
Cxref: cxref -warn-all -xref-all -block-comments -O/work/woods/f-yajl/build/work/woods/f-yajl/doc/html -Nyajl -html -html-src -I/work/woods/f-yajl/src -I/work/woods/f-yajl/build/work/woods/f-yajl/./src-CPP "cc -E -CC -x c" reformatter/json_reformat.c
CPP  : cc -E -CC -x c -Isrc -Ibuild/work/woods/f-yajl/./src
-->

<HTML>

<HEAD>
<TITLE>Source File reformatter/json_reformat.c</TITLE>
<LINK rel="stylesheet" href="../cxref.css" type="text/css">
</HEAD>

<BODY>

<pre>
<a name="line1">1    |</a> /*
<a name="line2">2    |</a>  * Copyright (c) 2007-2014, Lloyd Hilaiel &lt;me@lloyd.io&gt;
<a name="line3">3    |</a>  *
<a name="line4">4    |</a>  * Permission to use, copy, modify, and/or distribute this software for any
<a name="line5">5    |</a>  * purpose with or without fee is hereby granted, provided that the above
<a name="line6">6    |</a>  * copyright notice and this permission notice appear in all copies.
<a name="line7">7    |</a>  *
<a name="line8">8    |</a>  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
<a name="line9">9    |</a>  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
<a name="line10">10   |</a>  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
<a name="line11">11   |</a>  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
<a name="line12">12   |</a>  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
<a name="line13">13   |</a>  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
<a name="line14">14   |</a>  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
<a name="line15">15   |</a>  */
<a name="line16">16   |</a> 
<a name="line17">17   |</a> #include &lt;yajl/yajl_parse.h&gt;
<a name="line18">18   |</a> #include &lt;yajl/yajl_gen.h&gt;
<a name="line19">19   |</a> 
<a name="line20">20   |</a> #include &lt;stdio.h&gt;
<a name="line21">21   |</a> #include &lt;stdlib.h&gt;
<a name="line22">22   |</a> #include &lt;string.h&gt;
<a name="line23">23   |</a> 
<a name="line24">24   |</a> /* non-zero when we're reformatting a stream */
<a name="line25">25   |</a> static int s_streamReformat = 0;
<a name="line26">26   |</a> 
<a name="line27">27   |</a> #define GEN_AND_RETURN(func)                                          \
<a name="line28">28   |</a>     {                                                                 \
<a name="line29">29   |</a>         yajl_gen_status __stat = func;                                \
<a name="line30">30   |</a>         if (__stat == yajl_gen_generation_complete &amp;&amp; s_streamReformat) { \
<a name="line31">31   |</a>             yajl_gen_reset(g, "\n");                                    \
<a name="line32">32   |</a>             __stat = func;                                              \
<a name="line33">33   |</a>         }                                                               \
<a name="line34">34   |</a>         return __stat == yajl_gen_status_ok;                            \
<a name="line35">35   |</a>     }
<a name="line36">36   |</a> 
<a name="line37">37   |</a> static int reformat_null(void * ctx)
<a name="line38">38   |</a> {
<a name="line39">39   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line40">40   |</a>     GEN_AND_RETURN(yajl_gen_null(g));
<a name="line41">41   |</a> }
<a name="line42">42   |</a> 
<a name="line43">43   |</a> static int reformat_boolean(void * ctx, int boolean)
<a name="line44">44   |</a> {
<a name="line45">45   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line46">46   |</a>     GEN_AND_RETURN(yajl_gen_bool(g, boolean));
<a name="line47">47   |</a> }
<a name="line48">48   |</a> 
<a name="line49">49   |</a> static int reformat_number(void * ctx, const char * s, size_t l)
<a name="line50">50   |</a> {
<a name="line51">51   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line52">52   |</a>     GEN_AND_RETURN(yajl_gen_number(g, s, l));
<a name="line53">53   |</a> }
<a name="line54">54   |</a> 
<a name="line55">55   |</a> static int reformat_string(void * ctx, const unsigned char * stringVal,
<a name="line56">56   |</a>                            size_t stringLen)
<a name="line57">57   |</a> {
<a name="line58">58   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line59">59   |</a>     GEN_AND_RETURN(yajl_gen_string(g, stringVal, stringLen));
<a name="line60">60   |</a> }
<a name="line61">61   |</a> 
<a name="line62">62   |</a> static int reformat_map_key(void * ctx, const unsigned char * stringVal,
<a name="line63">63   |</a>                             size_t stringLen)
<a name="line64">64   |</a> {
<a name="line65">65   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line66">66   |</a>     GEN_AND_RETURN(yajl_gen_string(g, stringVal, stringLen));
<a name="line67">67   |</a> }
<a name="line68">68   |</a> 
<a name="line69">69   |</a> static int reformat_start_map(void * ctx)
<a name="line70">70   |</a> {
<a name="line71">71   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line72">72   |</a>     GEN_AND_RETURN(yajl_gen_map_open(g));
<a name="line73">73   |</a> }
<a name="line74">74   |</a> 
<a name="line75">75   |</a> 
<a name="line76">76   |</a> static int reformat_end_map(void * ctx)
<a name="line77">77   |</a> {
<a name="line78">78   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line79">79   |</a>     GEN_AND_RETURN(yajl_gen_map_close(g));
<a name="line80">80   |</a> }
<a name="line81">81   |</a> 
<a name="line82">82   |</a> static int reformat_start_array(void * ctx)
<a name="line83">83   |</a> {
<a name="line84">84   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line85">85   |</a>     GEN_AND_RETURN(yajl_gen_array_open(g));
<a name="line86">86   |</a> }
<a name="line87">87   |</a> 
<a name="line88">88   |</a> static int reformat_end_array(void * ctx)
<a name="line89">89   |</a> {
<a name="line90">90   |</a>     yajl_gen g = (yajl_gen) ctx;
<a name="line91">91   |</a>     GEN_AND_RETURN(yajl_gen_array_close(g));
<a name="line92">92   |</a> }
<a name="line93">93   |</a> 
<a name="line94">94   |</a> static yajl_callbacks callbacks = {
<a name="line95">95   |</a>     reformat_null,
<a name="line96">96   |</a>     reformat_boolean,
<a name="line97">97   |</a>     NULL,
<a name="line98">98   |</a>     NULL,
<a name="line99">99   |</a>     reformat_number,
<a name="line100">100  |</a>     reformat_string,
<a name="line101">101  |</a>     reformat_start_map,
<a name="line102">102  |</a>     reformat_map_key,
<a name="line103">103  |</a>     reformat_end_map,
<a name="line104">104  |</a>     reformat_start_array,
<a name="line105">105  |</a>     reformat_end_array
<a name="line106">106  |</a> };
<a name="line107">107  |</a> 
<a name="line108">108  |</a> #ifndef EXIT_USAGE
<a name="line109">109  |</a> # define EXIT_USAGE	2
<a name="line110">110  |</a> #endif
<a name="line111">111  |</a> 
<a name="line112">112  |</a> static void
<a name="line113">113  |</a> usage(const char * progname)
<a name="line114">114  |</a> {
<a name="line115">115  |</a>     fprintf(stderr, "%s: reformat json from stdin\n"
<a name="line116">116  |</a>             "usage:  json_reformat [options]\n"
<a name="line117">117  |</a>             "    -e escape any forward slashes (for embedding in HTML)\n"
<a name="line118">118  |</a>             "    -m minimize json rather than beautify (default)\n"
<a name="line119">119  |</a>             "    -s reformat a stream of multiple json entites\n"
<a name="line120">120  |</a>             "    -u allow invalid UTF8 inside strings during parsing\n",
<a name="line121">121  |</a>             progname);
<a name="line122">122  |</a>     exit(EXIT_USAGE);
<a name="line123">123  |</a> }
<a name="line124">124  |</a> 
<a name="line125">125  |</a> int
<a name="line126">126  |</a> main(int argc, char ** argv)
<a name="line127">127  |</a> {
<a name="line128">128  |</a>     yajl_handle hand;
<a name="line129">129  |</a>     static unsigned char fileData[65536];
<a name="line130">130  |</a>     /* generator config */
<a name="line131">131  |</a>     yajl_gen g;
<a name="line132">132  |</a>     yajl_status stat;
<a name="line133">133  |</a>     size_t rd;
<a name="line134">134  |</a>     int retval = 0;
<a name="line135">135  |</a>     int a = 1;
<a name="line136">136  |</a> 
<a name="line137">137  |</a>     g = yajl_gen_alloc(NULL);
<a name="line138">138  |</a>     yajl_gen_config(g, yajl_gen_beautify, 1);
<a name="line139">139  |</a>     yajl_gen_config(g, yajl_gen_validate_utf8, 1);
<a name="line140">140  |</a> 
<a name="line141">141  |</a>     /* ok.  open file.  let's read and parse */
<a name="line142">142  |</a>     hand = yajl_alloc(&amp;callbacks, NULL, (void *) g);
<a name="line143">143  |</a>     /* and let's allow comments by default */
<a name="line144">144  |</a>     yajl_config(hand, yajl_allow_comments, 1);
<a name="line145">145  |</a> 
<a name="line146">146  |</a>     /* check arguments.*/
<a name="line147">147  |</a>     while ((a &lt; argc) &amp;&amp; (argv[a][0] == '-') &amp;&amp; (strlen(argv[a]) &gt; 1)) {
<a name="line148">148  |</a>         unsigned int i;
<a name="line149">149  |</a>         for ( i=1; i &lt; strlen(argv[a]); i++) {
<a name="line150">150  |</a>             switch (argv[a][i]) {
<a name="line151">151  |</a>                 case 'm':
<a name="line152">152  |</a>                     yajl_gen_config(g, yajl_gen_beautify, 0);
<a name="line153">153  |</a>                     break;
<a name="line154">154  |</a>                 case 's':
<a name="line155">155  |</a>                     yajl_config(hand, yajl_allow_multiple_values, 1);
<a name="line156">156  |</a>                     s_streamReformat = 1;
<a name="line157">157  |</a>                     break;
<a name="line158">158  |</a>                 case 'u':
<a name="line159">159  |</a>                     yajl_config(hand, yajl_dont_validate_strings, 1);
<a name="line160">160  |</a>                     break;
<a name="line161">161  |</a>                 case 'e':
<a name="line162">162  |</a>                     yajl_gen_config(g, yajl_gen_escape_solidus, 1);
<a name="line163">163  |</a>                     break;
<a name="line164">164  |</a>                 default:
<a name="line165">165  |</a>                     fprintf(stderr, "unrecognized option: '%c'\n\n",
<a name="line166">166  |</a>                             argv[a][i]);
<a name="line167">167  |</a>                     usage(argv[0]);
<a name="line168">168  |</a>             }
<a name="line169">169  |</a>         }
<a name="line170">170  |</a>         ++a;
<a name="line171">171  |</a>     }
<a name="line172">172  |</a>     if (a &lt; argc) {
<a name="line173">173  |</a>         usage(argv[0]);
<a name="line174">174  |</a>     }
<a name="line175">175  |</a> 
<a name="line176">176  |</a>     for (;;) {
<a name="line177">177  |</a>         rd = fread((void *) fileData, (size_t) 1, sizeof(fileData) - 1, stdin);
<a name="line178">178  |</a> 
<a name="line179">179  |</a>         if (rd == 0) {
<a name="line180">180  |</a>             if (!feof(stdin)) {
<a name="line181">181  |</a>                 fprintf(stderr, "error on file read.\n");
<a name="line182">182  |</a>                 retval = 1;
<a name="line183">183  |</a>             }
<a name="line184">184  |</a>             break;
<a name="line185">185  |</a>         }
<a name="line186">186  |</a>         fileData[rd] = 0;
<a name="line187">187  |</a> 
<a name="line188">188  |</a>         stat = yajl_parse(hand, fileData, rd);
<a name="line189">189  |</a> 
<a name="line190">190  |</a>         if (stat != yajl_status_ok) {
<a name="line191">191  |</a>             break;
<a name="line192">192  |</a>         } else {
<a name="line193">193  |</a>             const unsigned char * buf;
<a name="line194">194  |</a>             size_t len;
<a name="line195">195  |</a>             yajl_gen_get_buf(g, &amp;buf, &amp;len);
<a name="line196">196  |</a>             fwrite(buf, (size_t) 1, len, stdout);
<a name="line197">197  |</a>             yajl_gen_clear(g);
<a name="line198">198  |</a>         }
<a name="line199">199  |</a>     }
<a name="line200">200  |</a> 
<a name="line201">201  |</a>     if (stat != yajl_status_ok) {
<a name="line202">202  |</a>         unsigned char * str = yajl_get_error(hand, 1, fileData, rd);
<a name="line203">203  |</a>         fprintf(stderr, "%s", (const char *) str);
<a name="line204">204  |</a>         yajl_free_error(hand, str);
<a name="line205">205  |</a>         retval = 1;
<a name="line206">206  |</a>     } else {
<a name="line207">207  |</a>         stat = yajl_complete_parse(hand);
<a name="line208">208  |</a>     }
<a name="line209">209  |</a> 
<a name="line210">210  |</a>     yajl_gen_free(g);
<a name="line211">211  |</a>     yajl_free(hand);
<a name="line212">212  |</a> 
<a name="line213">213  |</a>     return retval;
<a name="line214">214  |</a> }
</pre>

</BODY>
</HTML>
